// Generated by CoffeeScript 1.10.0
(function() {
  var fPrint;

  fPrint = (function() {
    fPrint.uniqueId = null;

    function fPrint() {
      this.init();
    }

    fPrint.prototype.init = function() {
      var needUpdate, uid;
      needUpdate = this.checkSession();
      console.log("need update is " + needUpdate);
      if (needUpdate) {
        uid = this.generateFp();
        this.writeSession();
        this.sendToServer(uid);
      }
      return this.handleView();
    };

    fPrint.prototype.generateFp = function() {
      return this.uniqueId = new Fingerprint().get();
    };

    fPrint.prototype.checkSession = function() {
      var lastStore;
      lastStore = sessionStorage.getItem('fpstored');
      if ((lastStore != null)) {
        if ((this.getTimestamp() - lastStore) >= 60 * 60) {
          return true;
        }
      } else {
        return true;
      }
      return false;
    };

    fPrint.prototype.writeSession = function() {
      return sessionStorage.setItem('fpstored', this.getTimestamp());
    };

    fPrint.prototype.getTimestamp = function() {
      return Math.floor(Date.now() / 1000);
    };

    fPrint.prototype.sendToServer = function(uid) {
      if (uid == null) {
        return;
      }
      return $.ajax({
        type: 'POST',
        url: '/',
        data: {
          fp_key: uid,
          fp_command: 'update_u_key',
          fp_userid: window.site_uid
        }
      });
    };

    fPrint.prototype.handleView = function() {
      var $btn;
      $btn = $(".js-pf-view-userkeys");
      $btn.off('click');
      return $btn.on('click', function(e) {
        var $dialog, userid;
        userid = $btn.attr('data-uid');
        $dialog = $("#expand-user-footprints");
        if (($dialog != null)) {
          $.ajax({
            type: "POST",
            url: '/',
            data: {
              fp_command: 'get_userkeys',
              fp_userid: userid != null ? userid : 0
            },
            success: function(response) {
              var html, i, len, row, rows;
              rows = JSON.parse(response);
              html = "";
              if ((rows != null)) {
                html += "Date | key <br />";
                for (i = 0, len = rows.length; i < len; i++) {
                  row = rows[i];
                  html += row.dateline + " > " + row.userkey + " <br />";
                }
              } else {
                html = "��� ������.";
              }
              $dialog.find('.modal-body').html(html);
              return $dialog.modal("show");
            }
          });
        }
        return e.preventDefault();
      });
    };

    return fPrint;

  })();

  $(function() {
    return window.fp = new fPrint();
  });

}).call(this);

//# sourceMappingURL=fprint.js.map
